#!/usr/bin/env bash
# Tail logs with syntax highlighting
# Usage: logtail /var/log/syslog
#        logtail -n 50 /var/log/auth.log

set -euo pipefail

LINES=20

usage() {
    echo "Usage: $(basename "$0") [-n lines] <logfile>"
    echo ""
    echo "Options:"
    echo "  -n NUM    Number of lines (default: 20)"
    echo "  -f        Follow (like tail -f)"
    echo ""
    echo "Highlights: ERROR/FAIL (red), WARN (yellow), INFO/OK (green), DEBUG (cyan)"
    exit 1
}

FOLLOW=0

while [[ $# -gt 0 ]]; do
    case $1 in
        -n) LINES="$2"; shift 2 ;;
        -f) FOLLOW=1; shift ;;
        -h|--help) usage ;;
        -*) echo "Unknown option: $1"; usage ;;
        *) FILE="$1"; shift ;;
    esac
done

[[ -z "${FILE:-}" ]] && usage
[[ ! -f "$FILE" ]] && echo "Error: File not found: $FILE" && exit 1

# Highlight function using sed
highlight() {
    sed \
        -e 's/\(ERROR\|FATAL\|FAIL\|CRITICAL\)/\x1b[31m\1\x1b[0m/gi' \
        -e 's/\(WARN\|WARNING\)/\x1b[33m\1\x1b[0m/gi' \
        -e 's/\(INFO\|OK\|SUCCESS\)/\x1b[32m\1\x1b[0m/gi' \
        -e 's/\(DEBUG\|TRACE\)/\x1b[36m\1\x1b[0m/gi' \
        -e 's/\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\)/\x1b[35m\1\x1b[0m/g' \
        -e 's/\([0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}\)/\x1b[35m\1\x1b[0m/g'
}

if [[ $FOLLOW -eq 1 ]]; then
    tail -f "$FILE" | highlight
else
    tail -n "$LINES" "$FILE" | highlight
fi
